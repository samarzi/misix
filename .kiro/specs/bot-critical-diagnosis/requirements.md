# Requirements Document: Bot Critical Diagnosis and Fix

## Introduction

Пользователь сообщает, что бот MISIX не работает - не функционируют базовые команды, кнопки, память, и веб-приложение. Работает только базовый AI-ответ. Необходимо провести полную диагностику и исправить все критические проблемы.

## Glossary

- **Bot**: Telegram-бот MISIX
- **Handler**: Обработчик команд/сообщений в боте
- **Database**: База данных Supabase PostgreSQL
- **AI Service**: Сервис интеграции с Yandex GPT
- **Memory**: Контекстная память разговоров
- **Web App**: Веб-приложение на Netlify

## Requirements

### Requirement 1: Диагностика текущего состояния

**User Story:** Как разработчик, я хочу понять что именно не работает в боте, чтобы определить корневые причины проблем.

#### Acceptance Criteria

1. WHEN диагностика запускается, THE System SHALL проверить подключение к базе данных
2. WHEN диагностика запускается, THE System SHALL проверить регистрацию всех handlers
3. WHEN диагностика запускается, THE System SHALL проверить доступность AI сервиса
4. WHEN диагностика запускается, THE System SHALL проверить наличие всех таблиц в БД
5. WHEN диагностика запускается, THE System SHALL проверить работу команд бота

### Requirement 2: Исправление подключения к базе данных

**User Story:** Как пользователь, я хочу чтобы бот сохранял мои данные в базу, чтобы иметь историю и память.

#### Acceptance Criteria

1. WHEN пользователь отправляет сообщение, THE Bot SHALL сохранить его в таблицу assistant_messages
2. WHEN пользователь создает задачу, THE Bot SHALL сохранить её в таблицу tasks
3. IF база данных недоступна, THEN THE Bot SHALL работать с in-memory данными
4. WHEN база данных восстанавливается, THE Bot SHALL синхронизировать данные
5. WHEN происходит ошибка БД, THE Bot SHALL логировать детали ошибки

### Requirement 3: Восстановление работы команд

**User Story:** Как пользователь, я хочу использовать команды бота (/start, /help, /tasks и т.д.), чтобы быстро получать нужную информацию.

#### Acceptance Criteria

1. WHEN пользователь отправляет /start, THE Bot SHALL ответить приветственным сообщением
2. WHEN пользователь отправляет /help, THE Bot SHALL показать справку
3. WHEN пользователь отправляет /tasks, THE Bot SHALL показать список задач
4. WHEN пользователь отправляет /finances, THE Bot SHALL показать финансовую сводку
5. WHEN пользователь отправляет /mood, THE Bot SHALL показать историю настроения
6. WHEN пользователь отправляет /profile, THE Bot SHALL показать профиль
7. WHEN пользователь отправляет /reminders, THE Bot SHALL показать настройки напоминаний

### Requirement 4: Восстановление кнопок и callback handlers

**User Story:** Как пользователь, я хочу использовать inline кнопки для быстрых действий, чтобы не писать команды вручную.

#### Acceptance Criteria

1. WHEN пользователь нажимает кнопку "Я спать", THE Bot SHALL начать трекинг сна
2. WHEN пользователь нажимает кнопку в настройках напоминаний, THE Bot SHALL обработать действие
3. WHEN callback обрабатывается, THE Bot SHALL обновить сообщение с кнопками
4. WHEN callback обрабатывается, THE Bot SHALL показать уведомление пользователю
5. IF callback обработка fails, THEN THE Bot SHALL показать сообщение об ошибке

### Requirement 5: Восстановление контекстной памяти

**User Story:** Как пользователь, я хочу чтобы бот помнил наш разговор, чтобы не повторяться и получать релевантные ответы.

#### Acceptance Criteria

1. WHEN пользователь отправляет сообщение, THE Bot SHALL сохранить его в историю
2. WHEN бот генерирует ответ, THE Bot SHALL использовать последние 6 сообщений как контекст
3. WHEN пользователь спрашивает "что я делал вчера", THE Bot SHALL найти информацию в истории
4. WHEN история превышает лимит, THE Bot SHALL хранить только последние N сообщений
5. WHEN пользователь новый, THE Bot SHALL создать пустую историю

### Requirement 6: Проверка веб-приложения

**User Story:** Как пользователь, я хочу использовать веб-интерфейс для управления данными, чтобы иметь визуальный доступ к информации.

#### Acceptance Criteria

1. WHEN пользователь открывает веб-приложение, THE App SHALL загрузиться без ошибок
2. WHEN пользователь пытается войти, THE App SHALL отправить запрос к API
3. WHEN API недоступен, THE App SHALL показать понятное сообщение об ошибке
4. WHEN пользователь авторизован, THE App SHALL показать данные из API
5. WHEN происходит ошибка CORS, THE App SHALL логировать детали

### Requirement 7: Проверка запуска бота

**User Story:** Как администратор, я хочу убедиться что бот правильно запускается, чтобы он был доступен пользователям.

#### Acceptance Criteria

1. WHEN бот запускается, THE System SHALL инициализировать все handlers
2. WHEN бот запускается, THE System SHALL подключиться к базе данных
3. WHEN бот запускается, THE System SHALL запустить scheduler для напоминаний
4. WHEN бот запускается, THE System SHALL логировать успешный старт
5. IF запуск fails, THEN THE System SHALL логировать детальную ошибку

### Requirement 8: Создание диагностического скрипта

**User Story:** Как разработчик, я хочу иметь скрипт для быстрой диагностики, чтобы проверять состояние системы.

#### Acceptance Criteria

1. WHEN скрипт запускается, THE Script SHALL проверить все переменные окружения
2. WHEN скрипт запускается, THE Script SHALL проверить подключение к Supabase
3. WHEN скрипт запускается, THE Script SHALL проверить доступность Yandex GPT
4. WHEN скрипт запускается, THE Script SHALL проверить наличие всех таблиц
5. WHEN скрипт завершается, THE Script SHALL вывести отчет о состоянии системы

### Requirement 9: Исправление миграций базы данных

**User Story:** Как администратор, я хочу убедиться что все таблицы созданы правильно, чтобы бот мог сохранять данные.

#### Acceptance Criteria

1. WHEN миграция запускается, THE System SHALL создать все необходимые таблицы
2. WHEN миграция запускается, THE System SHALL создать все индексы
3. WHEN миграция запускается, THE System SHALL создать все foreign keys
4. IF таблица уже существует, THEN THE System SHALL пропустить создание
5. WHEN миграция завершается, THE System SHALL проверить целостность схемы

### Requirement 10: Логирование и мониторинг

**User Story:** Как разработчик, я хочу видеть детальные логи работы бота, чтобы быстро находить и исправлять проблемы.

#### Acceptance Criteria

1. WHEN происходит ошибка, THE System SHALL логировать stack trace
2. WHEN обрабатывается сообщение, THE System SHALL логировать user_id и message_id
3. WHEN вызывается API, THE System SHALL логировать request и response
4. WHEN происходит timeout, THE System SHALL логировать время выполнения
5. WHEN бот работает, THE System SHALL логировать heartbeat каждые 60 секунд
