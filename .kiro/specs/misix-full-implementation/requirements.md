# Requirements Document - MISIX Full Implementation

## Introduction

Данный документ описывает требования к полной реализации функционала MISIX согласно исходному ТЗ. Система должна автоматически извлекать структурированные данные из естественного разговора пользователя и сохранять их в соответствующие модули (задачи, финансы, заметки, настроение).

## Glossary

- **MessageHandler**: Обработчик сообщений в Telegram боте
- **IntentClassifier**: Компонент для классификации намерений пользователя
- **DataExtractor**: Компонент для извлечения структурированных данных из текста
- **TaskService**: Сервис для работы с задачами
- **FinanceService**: Сервис для работы с финансами
- **NoteService**: Сервис для работы с заметками
- **MoodService**: Сервис для работы с настроением (новый)
- **AIService**: Сервис для работы с Yandex GPT

## Requirements

### Requirement 1: Автоматическое извлечение задач

**User Story:** Как пользователь, я хочу создавать задачи через естественный разговор, чтобы не использовать команды

#### Acceptance Criteria

1. WHEN пользователь пишет "напомни завтра позвонить партнеру", THE System SHALL распознать намерение создания задачи
2. WHEN намерение распознано, THE System SHALL извлечь название задачи, дедлайн и приоритет
3. WHEN данные извлечены, THE TaskService SHALL создать задачу в базе данных
4. WHEN задача создана, THE System SHALL подтвердить создание пользователю
5. THE System SHALL поддерживать различные формулировки создания задач

### Requirement 2: Автоматический учет финансов

**User Story:** Как пользователь, я хочу записывать расходы и доходы через естественный разговор, чтобы быстро вести учет

#### Acceptance Criteria

1. WHEN пользователь пишет "потратил 500 рублей на еду", THE System SHALL распознать намерение записи расхода
2. WHEN намерение распознано, THE System SHALL извлечь сумму, категорию и описание
3. WHEN данные извлечены, THE FinanceService SHALL создать запись о расходе
4. WHEN запись создана, THE System SHALL подтвердить с указанием категории
5. THE System SHALL автоматически определять категорию расхода

### Requirement 3: Сохранение заметок

**User Story:** Как пользователь, я хочу сохранять важную информацию через разговор, чтобы не забыть детали

#### Acceptance Criteria

1. WHEN пользователь пишет "запомни что встреча в офисе на Ленина 5", THE System SHALL распознать намерение сохранения заметки
2. WHEN намерение распознано, THE System SHALL извлечь содержание заметки
3. WHEN данные извлечены, THE NoteService SHALL создать заметку
4. WHEN заметка создана, THE System SHALL подтвердить сохранение
5. THE System SHALL поддерживать различные формулировки сохранения информации

### Requirement 4: Отслеживание настроения

**User Story:** Как пользователь, я хочу отмечать свое настроение, чтобы отслеживать эмоциональное состояние

#### Acceptance Criteria

1. WHEN пользователь пишет о своем настроении, THE System SHALL распознать эмоциональный контекст
2. WHEN эмоция распознана, THE MoodService SHALL сохранить запись о настроении
3. WHEN запись сохранена, THE System SHALL подтвердить с эмпатичным ответом
4. THE System SHALL анализировать тональность сообщений для определения настроения
5. THE System SHALL сохранять временные метки для отслеживания динамики

### Requirement 5: Интеграция с существующими сервисами

**User Story:** Как разработчик, я хочу использовать существующие сервисы, чтобы избежать дублирования кода

#### Acceptance Criteria

1. THE MessageHandler SHALL использовать AIService для классификации намерений
2. THE MessageHandler SHALL использовать AIService для извлечения данных
3. THE MessageHandler SHALL использовать существующие TaskService, FinanceService, NoteService
4. THE System SHALL логировать все операции извлечения и сохранения данных
5. IF извлечение данных не удалось, THEN THE System SHALL продолжить обычный разговор

### Requirement 6: Множественные намерения

**User Story:** Как пользователь, я хочу выражать несколько намерений в одном сообщении, чтобы общаться естественно

#### Acceptance Criteria

1. WHEN пользователь пишет "потратил 200₽ на кофе и напомни купить молоко", THE System SHALL распознать оба намерения
2. WHEN несколько намерений распознаны, THE System SHALL обработать каждое отдельно
3. WHEN все намерения обработаны, THE System SHALL подтвердить все действия
4. THE System SHALL сохранять порядок обработки намерений
5. THE System SHALL корректно обрабатывать до 3 намерений в одном сообщении

### Requirement 7: Контекстное понимание

**User Story:** Как пользователь, я хочу чтобы бот понимал контекст разговора, чтобы не повторяться

#### Acceptance Criteria

1. WHEN пользователь ссылается на предыдущее сообщение, THE System SHALL использовать контекст разговора
2. WHEN контекст используется, THE System SHALL корректно интерпретировать местоимения и ссылки
3. THE System SHALL учитывать последние 6 сообщений для контекста
4. THE System SHALL сохранять созданные сущности в контексте сессии
5. WHEN сессия завершена, THE System SHALL очистить временный контекст

### Requirement 8: Обработка ошибок извлечения

**User Story:** Как пользователь, я хочу получать понятные уточнения, если бот не понял мое намерение

#### Acceptance Criteria

1. IF извлечение данных неполное, THEN THE System SHALL запросить недостающую информацию
2. WHEN пользователь уточняет информацию, THE System SHALL дополнить данные и создать сущность
3. IF намерение неясно, THEN THE System SHALL продолжить обычный разговор
4. THE System SHALL не создавать сущности с низкой уверенностью (< 0.7)
5. THE System SHALL логировать случаи неуспешного извлечения для улучшения
