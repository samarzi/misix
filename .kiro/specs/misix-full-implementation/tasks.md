# Implementation Plan - MISIX Full Implementation

- [x] 1. Создать модель и репозиторий для настроения
  - Создать модель MoodEntry в models/mood.py
  - Создать MoodRepository в repositories/mood.py с методами save и get_by_user_and_period
  - Создать миграцию для таблицы mood_entries
  - _Requirements: 4.2_

- [x] 2. Создать MoodService
  - Создать файл services/mood_service.py
  - Реализовать метод save_mood для сохранения записей о настроении
  - Реализовать метод get_mood_history для получения истории
  - Реализовать метод analyze_mood_trends для анализа трендов
  - _Requirements: 4.2, 4.3_

- [x] 3. Создать ExtractionService
  - Создать файл services/extraction_service.py
  - Реализовать базовый класс ExtractionService с зависимостью от AIService
  - _Requirements: 5.2_

- [x] 3.1 Реализовать извлечение данных задач
  - Создать метод extract_task_data с промптом для Yandex GPT
  - Реализовать парсинг относительных дат (завтра, через неделю)
  - Добавить валидацию уверенности (confidence > 0.7)
  - Вернуть структурированные данные или None
  - _Requirements: 1.2, 1.3_

- [x] 3.2 Реализовать извлечение финансовых данных
  - Создать метод extract_finance_data с промптом для Yandex GPT
  - Реализовать автоматическое определение категории
  - Добавить поддержку различных валют и форматов сумм
  - Вернуть структурированные данные или None
  - _Requirements: 2.2, 2.5_

- [x] 3.3 Реализовать извлечение заметок
  - Создать метод extract_note_data с промптом для Yandex GPT
  - Извлекать заголовок и содержание
  - Вернуть структурированные данные или None
  - _Requirements: 3.2_

- [x] 3.4 Реализовать анализ настроения
  - Создать метод extract_mood_data с промптом для Yandex GPT
  - Определять тип настроения (happy, sad, anxious, etc.)
  - Определять интенсивность (1-10)
  - Извлекать дополнительные заметки
  - _Requirements: 4.1, 4.4_

- [x] 4. Улучшить AIService для множественных намерений
  - Обновить метод classify_intent для возврата списка намерений
  - Изменить промпт для поддержки множественных намерений
  - Добавить поле confidence для каждого намерения
  - Вернуть отсортированный список по уверенности
  - _Requirements: 6.1, 6.2_

- [x] 5. Создать IntentProcessor
  - Создать файл bot/intent_processor.py
  - Реализовать класс IntentProcessor с методом process_intents
  - Метод должен принимать список намерений и сообщение
  - Для каждого намерения вызывать соответствующий extractor
  - Сохранять извлеченные данные через сервисы
  - Возвращать список созданных сущностей
  - _Requirements: 5.1, 5.2, 5.3, 6.2, 6.3_

- [x] 5.1 Обработка намерения create_task
  - Вызвать extraction_service.extract_task_data
  - Если данные извлечены, вызвать task_service.create
  - Вернуть информацию о созданной задаче
  - Залогировать действие
  - _Requirements: 1.3, 1.4, 5.4_

- [x] 5.2 Обработка намерения add_expense/add_income
  - Вызвать extraction_service.extract_finance_data
  - Если данные извлечены, вызвать finance_service.create
  - Вернуть информацию о созданной записи
  - Залогировать действие
  - _Requirements: 2.3, 2.4, 5.4_

- [x] 5.3 Обработка намерения save_note
  - Вызвать extraction_service.extract_note_data
  - Если данные извлечены, вызвать note_service.create
  - Вернуть информацию о созданной заметке
  - Залогировать действие
  - _Requirements: 3.3, 3.4, 5.4_

- [x] 5.4 Обработка намерения track_mood
  - Вызвать extraction_service.extract_mood_data
  - Если данные извлечены, вызвать mood_service.save_mood
  - Вернуть информацию о записи настроения
  - Залогировать действие
  - _Requirements: 4.2, 4.3, 5.4_

- [x] 6. Обновить MessageHandler для интеграции
  - Добавить импорты ExtractionService и IntentProcessor
  - После сохранения сообщения пользователя вызвать classify_intent
  - Если уверенность > 0.7, вызвать intent_processor.process_intents
  - Сохранить список созданных сущностей
  - Передать сущности в generate_response через system_prompt
  - _Requirements: 5.1, 5.2, 5.3, 5.5, 6.3_

- [x] 7. Создать ResponseBuilder
  - Создать файл bot/response_builder.py
  - Реализовать метод build_confirmation для создания подтверждений
  - Поддержать все типы сущностей (task, expense, income, note, mood)
  - Использовать эмодзи для наглядности
  - Вернуть текст подтверждений
  - _Requirements: 1.4, 2.4, 3.4, 4.3_

- [x] 8. Интегрировать подтверждения в AI ответ
  - В MessageHandler после обработки намерений построить подтверждения
  - Добавить подтверждения в system_prompt для AI
  - AI должен естественно включить подтверждения в ответ
  - _Requirements: 1.4, 2.4, 3.4, 4.3, 6.3_

- [x] 9. Добавить обработку ошибок извлечения
  - Если confidence < 0.7, пропустить извлечение
  - Залогировать случаи низкой уверенности
  - Продолжить обычный разговор без создания сущностей
  - Если извлечение выбросило исключение, залогировать и продолжить
  - _Requirements: 5.5, 8.1, 8.3, 8.4, 8.5_

- [ ]* 10. Создать миграцию для mood_entries
  - Создать SQL файл в backend/migrations/
  - Добавить таблицу mood_entries с полями из дизайна
  - Добавить индексы для user_id и created_at
  - Добавить триггер для updated_at
  - _Requirements: 4.2_

- [ ]* 11. Написать unit тесты для ExtractionService
  - Тест извлечения задачи из простого сообщения
  - Тест извлечения финансов с категорией
  - Тест извлечения заметки
  - Тест извлечения настроения
  - Тест обработки низкой уверенности
  - _Requirements: 1.2, 2.2, 3.2, 4.1_

- [ ]* 12. Написать integration тесты
  - Тест полного flow создания задачи через сообщение
  - Тест множественных намерений в одном сообщении
  - Тест сохранения в базу данных
  - Тест генерации подтверждений
  - _Requirements: 6.1, 6.2, 6.3_
