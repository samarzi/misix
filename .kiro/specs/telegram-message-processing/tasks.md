# Implementation Plan

- [x] 1. Добавить метод get_or_create_by_telegram_id в UserRepository
  - Реализовать метод для получения существующего пользователя или создания нового по telegram_id
  - Метод должен принимать telegram_id, username, first_name, last_name
  - Сначала пытаться получить существующего пользователя через get_by_telegram_id
  - Если пользователь не найден, создать нового через метод create
  - Вернуть данные пользователя (существующего или нового)
  - _Requirements: 1.2_

- [x] 2. Реализовать полноценную обработку сообщений в handle_text_message
  - Заменить заглушку на реальную логику обработки
  - Интегрировать все необходимые сервисы
  - Обеспечить правильный порядок операций
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 4.1, 4.5_

- [x] 2.1 Извлечь данные из Telegram Update
  - Получить effective_user из update
  - Извлечь message.text
  - Извлечь telegram_id, username, first_name, last_name
  - Залогировать получение сообщения с первыми 50 символами
  - _Requirements: 1.1, 4.1_

- [x] 2.2 Получить или создать пользователя
  - Инициализировать UserRepository через get_user_repository()
  - Вызвать get_or_create_by_telegram_id с данными из Telegram
  - Обработать случай недоступности БД (fallback на telegram_id как user_id)
  - Залогировать ошибку если БД недоступна
  - Получить user_id для дальнейшего использования
  - _Requirements: 1.2, 3.2, 4.5, 5.2_

- [x] 2.3 Получить контекст разговора
  - Инициализировать ConversationService через get_conversation_service()
  - Вызвать get_conversation_context с user_id
  - Сохранить контекст для передачи в AI
  - _Requirements: 1.3, 2.3_

- [x] 2.4 Сохранить сообщение пользователя в истории
  - Вызвать conv_service.add_message с role="user"
  - Передать user_id, content=message_text, telegram_id
  - _Requirements: 2.1, 4.4_

- [x] 2.5 Сгенерировать AI ответ
  - Инициализировать AIService через get_ai_service()
  - Вызвать generate_response с user_message и conversation_context
  - Обработать случай недоступности AI (fallback автоматический)
  - Залогировать длину сгенерированного ответа
  - _Requirements: 1.4, 3.1, 3.3, 4.2_

- [x] 2.6 Сохранить ответ ассистента в истории
  - Вызвать conv_service.add_message с role="assistant"
  - Передать user_id, content=response, telegram_id
  - _Requirements: 2.2, 4.4_

- [x] 2.7 Отправить ответ пользователю
  - Вызвать update.message.reply_text с сгенерированным ответом
  - _Requirements: 1.5_

- [x] 2.8 Добавить обработку ошибок
  - Обернуть всю логику в try-except блок
  - При ошибке залогировать с уровнем ERROR
  - Отправить пользователю понятное сообщение об ошибке
  - Обеспечить что пользователь всегда получает ответ
  - _Requirements: 5.1, 5.3, 5.4, 5.5_

- [ ]* 3. Написать unit тесты для handle_text_message
  - Создать тесты для проверки корректности обработки сообщений
  - Использовать моки для всех зависимостей
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ]* 3.1 Тест успешной обработки сообщения
  - Замокать все сервисы (UserRepository, ConversationService, AIService)
  - Замокать update.message.reply_text
  - Вызвать handle_text_message
  - Проверить правильный порядок вызовов всех сервисов
  - Проверить что reply_text вызван с правильным ответом
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ]* 3.2 Тест обработки при недоступной БД
  - Замокать UserRepository для выброса исключения
  - Проверить что используется telegram_id как fallback
  - Проверить что обработка продолжается
  - Проверить что пользователь получает ответ
  - _Requirements: 5.2_

- [ ]* 3.3 Тест обработки при недоступном AI
  - Замокать AIService для возврата fallback ответа
  - Проверить что пользователь получает fallback ответ
  - _Requirements: 3.1, 3.3_

- [ ]* 3.4 Тест обработки общих ошибок
  - Замокать сервис для выброса неожиданного исключения
  - Проверить что ошибка залогирована
  - Проверить что пользователь получает сообщение об ошибке
  - _Requirements: 5.1, 5.5_

- [ ]* 4. Написать unit тесты для get_or_create_by_telegram_id
  - Создать тесты для нового метода UserRepository
  - _Requirements: 1.2_

- [ ]* 4.1 Тест получения существующего пользователя
  - Замокать get_by_telegram_id для возврата пользователя
  - Вызвать get_or_create_by_telegram_id
  - Проверить что create не вызывался
  - Проверить что возвращен существующий пользователь
  - _Requirements: 1.2_

- [ ]* 4.2 Тест создания нового пользователя
  - Замокать get_by_telegram_id для возврата None
  - Замокать create для возврата нового пользователя
  - Вызвать get_or_create_by_telegram_id
  - Проверить что create вызван с правильными данными
  - Проверить что возвращен новый пользователь
  - _Requirements: 1.2_
